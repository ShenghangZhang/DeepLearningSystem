# CPU 基础

CPU是Central Processing Unit（中央处理器）的简称，它负责执行指令和计算，控制着计算机的所有组件。CPU从无到有，从弱小到强大，经历了漫长发展过程，其间发生了无数的故事。

## CPU发展历史和组成

  回顾历史，世界上第一台真正意义上的计算机ENIAC：(Electronic Numerical Integrator And Calculator，电子数字积分计算机），于1946年在美国宾夕法尼亚大学投入运行，采用十进制进行数据存储。最初也专门用于火炮弹道计算，后经多次改进而成为能进行各种科学计算的通用计算机。这台完全采用电子线路执行算术运算、逻辑运算和信息存储的计算机，运算速度比继电器计算机快1000倍。ENIAC的发明，奠定了电子计算机的发展基础，开辟了信息时代的新纪元，是人类第三次产业革命开始的标志，具有重要的历史意义。
  
  与ENIAC不同且更为人知的是EDVAC：（Electronic Discrete Variable Automatic Computer，电子离散变量自动计算机）。1945年3月由冯·诺伊曼本人与莫奇利、埃克特等提出，1951年最终完成。EDVAC是二进制串行计算机，具有加减乘和软件除的功能。一条加法指令约864微秒，乘法指令2900微秒（或2.9毫秒）。 使用延迟线存储器，具有1000个44位（bit）的字。这是世界上首次提出的第一台采用二进制的冯·诺依曼计算机，由运算器、控制器、存储器、输入和输出设备5部分组成，也就是我们熟知的冯·诺依曼架构。这种体系结构一直延续至今，现在使用的计算机，其基本工作原理仍然是存储程序和程序控制，所以现在一般计算机被称为冯诺依曼结构计算机。鉴于冯诺依曼在发明电子计算机中所起到关键性作用，他被西方人誉为"计算机之父"。（他在数学和经济学领域的贡献也很卓著，被称为“博弈论之父”。）

  CPU发展至今已经集成了大规模复杂的电路，可以把它看作是一个由很多小块组成的复杂机器，然而无论CPU的具体实现怎么变、晶体管数量翻多少番，这些小块从功能的角度大致可以划分成三大部分：算术逻辑单元、存储单元和控制单元.当然这里面其实只是一个简图，实际上中央处理单元，它的整个连线，整个IO，整个具体的控制流程是非常的复杂的，接下来简单介绍这些组成单元以及单元之间是怎么互相配合的。
  
  ![CPU组成](images/cpu/CPU03.png)
  
1) 算术逻辑单元（ALU，Arithmetic Logic Unit）
   
CPU的主要功能就是运算，这正是通过算术逻辑单元ALU实现的。ALU电路内部由算术单元（AU）和逻辑单元（LU）组合而成，可对两个输入值（操作数）执行算术或逻辑运算并产生一个输出值。算术单元负责对二进制数执行加减乘除等数学运算，而逻辑单元执行与、或、非等逻辑运算，以及对两个操作数进行比较等。另外ALU还具备位移功能，将输入的操作数向左或向右移动从而得到新的操作数.不只是CPU，其他如图形处理器GPU等几乎所有的微处理器中，ALU都是最基本的组件。

2) 存储单元（MU，Memory Unit）

存储单元（MU，Memory Unit）也可以称为寄存器，寄存器主要分为两种指令寄存器和数据寄存器，负责暂存指令、ALU所需操作数、ALU算出结果等。算术逻辑单元ALU在执行计算的时候，需要读取存储在寄存器中的操作数，计算结果则保存到累加器中（也是一种寄存器），ALU执行的命令则来自指令寄存器。比如，当将两个数字相加时，一个数字放在A寄存器中，另一个放在B寄存器中，ALU执行加法后将结果放入累加器中。如果是逻辑操作，则把要比较的数据放进输入寄存器中，比较的结果1或0放入累加器中。无论是逻辑运算还是算术运算，累加器内容都会被放入缓存中。

   ![存储单元](images/cpu/CPU06.png)

上述的寄存器（Register）和缓存（Cache）即CPU内部的存储单元，用于存储供CPU访问的数据和指令，以及存储任何计算或任务的中间结果。处理的最终结果也会被保存到存储单元中，然后将这些结果发布到输出设备提供给用户。不过CPU内部存储单元的容量极为有限，大量数据只能保存在CPU之外的RAM（随机存取存储器）芯片中，就是我们平常所说的内存，也被称之为主存。存储器单元负责从主存中检索并临时存储数据，负责管理CPU和主存之间的数据流。

3) 控制单元（CU，Control Unit）

控制单元负责从主存中检索和选取指令，对其进行解码，然后发出适当的控制信号，指导计算机的其他组件（如算术逻辑单元、存储单元、输入/输出设备等）执行所需的操作。控制单元自身并不执行程序指令，它只是输出信号指示系统的其他部分如何做。如果说CPU是计算机的大脑，那么控制单元就是CPU的大脑。

 ![控制单元](images/cpu/CPU05.png)

接下来我们来介绍一下这些主要单元是如何相互配合完成的也就是CPU的工作流，主要分为4步：1）从内存提取指令；2）解码；3）执行；4）写回。结合下图简单解释，第一步就是从内存里面去读取一些指令，给到我们的控制单元CU，而控制单元就会对我们的刚才读取的一些指令来进行解码，变成正式的一些 command 命令，然后 ALU 就会去执行这些command，这些命令执行完之后就会存储回来我们的内存进行汇总也就是写回。

![CPU工作流](images/cpu/CPU04.png)


我们平时使用C++、Java、Python等编程语言编译好的程序文件（机器码），保存在硬盘等存储介质上，当操作系统运行这些程序的时候，首先会将它们加载到系统内存中。程序文件实际就是一系列的指令，CPU从内存中检索并读取程序指令，然后通过控制单元对程序指令进行译码操作，使其转化为CPU能够“读懂”的指令格式。接下来控制单元向算术逻辑单元ALU发送信号，ALU即依据指令读取操作数并进行相应计算，其计算结果经由CPU内的存储单元返回内存中。在以上过程中，CPU执行了四个重要步骤：　1）从内存提取指令；2）解码；3）执行；4）写回。这四个步骤是完整执行一条指令的过程，称之为指令周期（Instruction Cycle）。这一过程循环往复地进行，直到程序结束。说起来简单，实际过程却很复杂。单以取指令这一步骤来说，它本身就又由多个微操作组成：　

1. 程序计数器初始化指针指向内存地址；
2. 内存地址被装载到CPU的地址寄存器中；
3. CPU接下来检索该内存地址中的数据，并将其载入数据寄存器中；
4. 如果数据包中包含的是指令，将其装载到指令寄存器中；
5. 程序计数器递增加1，指向下一个内存地址；
6. 指令寄存器中的指令被传入CPU的控制单元中；
7. 以上步骤循环往复地进行。

接下来的译码、执行等阶段，也都有着各自复杂的操作，感兴趣的伙伴可以详细学习计算机组成原理（计算机必修课）。

回到CPU的的架构，我们需要了解的是CPU三大组成的各自分工，控制器和寄存器负责的工作最多、要存的数据最多的两部分。下图是CPU的一个简要架构图，从下往上是DRAM（Dynamic Random Access Memory，动态随机存取存储器）以及Cache这些其实都可以当作是我们的内存，然后有控制器，真正的执行单元就是我们的ALU，我们可以看到真正执行单元的 ALU 占的面积是非常的小的，图中假设有 4 个ALU或者计算盒，而在整体电路里面占了绝大部分面积的是内存还有控制器，而并非计算，所以说 CPU 是非常适合擅长处理我们的逻辑控制，而并非计算。真正想要芯片具有非常好的计算性能，那就需要GPU，NPU，而不是CPU。当然我们后面会给大家介绍的。那下面我们来看一下 CPU 的约束和限制。


![CPU架构图](images/cpu/CPU02.png)


CPU 的约束和限制

实质上ALU模块(逻辑运算单元)是用来完成数据计算，其他各个模块的存在都是为了保证指令能够一条接一条的有序执行。这种通用性结构对于传统的编程计算模式非常适合，同时可以通过提升CPU主频(提升单位时间内执行指令的条数)来提升计算速度。 

但是，依照冯·诺依曼架构针对指令的“顺序执行”的原则，CPU 只能执行完一条指令再来下一条，计算能力进一步受限。当然了，我们会存在多核的情况，一次或可以执行多条指令，因为大原则受限于顺序执行，所以我们的计算能力的提升是受到限制的。于是我们引入了第二个内容，也就是本节的第二章，CPU并行处理架构。





## CPU并行处理架构

基于指令流的数量和数据流的数量，将计算机体系结构分为：
1. 单指令流单数流（SISD）系统。
2. 单指令流多数据流（SIMD）系统。
3. 多指令流单数据流（MISD）系统。
4. 多指令流多数据流（MIMD）系统



1） 单指令流单数流（SISD）系统。

顾名思义只有一个处理器和一个存储器，每个指令部件每次仅译码一条指令，而且在执行时仅为操作部件提供一份数据，串行计算，硬件不支持并行计算；在时钟周期内，CPU只能处理一个数据流，为了提高速度：
1. 采用流水线方式。
2. 设置多个功能部件，即为超标量处理机。
3. 多模块交叉方式组织存储器（内存的低位交叉编址）


2） 单指令流多数据流（SIMD）系统。

单指令流多数据流（SIMD）系统采用一个控制器控制多个处理器，同时对一组数据中每一个分别执行相同操作，SIMD主要执行向量、矩阵等数组运算，处理单元数目固定，适用于科学计算。特点是处理单元数量很多， 但处理单元速度受计算机通讯带宽传递速率的限制。一个指令流同时对多个数据流进行处理，同时称为数据级并行技术。 各指令序列只能并发，不能并行。一个指令控制部件、多个处理单元。每个执行单元有各自的寄存器组、局部存储器、地址寄存器。

3） 多指令流单数据流（MISD）系统。 

多指令流单数据流机器，采用多个指令流来处理单个数据流，这种方式没什么必要，所以仅作为理论模型出现，没有投入到实际应用之中


4） 多指令流多数据流（MIMD）系统

多指令流多数据流（MIMD）系统是在多个数据集上执行多个指令的多处理器机器，共享内存 MIMD 和分布式内存。特性是各处理器之间，可以通过LOAD/STORE指令，访问同一个主存储器，可通过主存相互传送数据。硬件组成为：一台计算机内，包含多个处理器加一个主存储器。多个处理器共享单一的物理地址空间。


## 本节视频

<html>
<iframe src="https://player.bilibili.com/player.html?aid=569330788&bvid=BV1tv4y1V72f&cid=1075822112&page=1&as_wide=1&high_quality=1&danmaku=0&t=30&autoplay=0" width="100%" height="500" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>
</html>
